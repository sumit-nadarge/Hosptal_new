<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Global Styles for Professional Look */
        body { font-family: 'Inter', sans-serif; }
        .nav-active { background-color: #0077b6; color: #ffffff; font-weight: 600; }
        .dashboard-container { min-height: 100vh; }

        /* Custom scrollbar updated to medical blue */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #0077b6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #005081; }

        /* Spin animation updated to medical blue */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #0077b6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom style for active buttons in multi-step patient flow */
        .city-selected { border-color: #0077b6; background-color: #e0f2fe; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0077b6', /* Deep Medical Blue */
                        'primary-dark': '#005081', /* Darker Blue */
                        'secondary': '#374151',
                        'sidebar-bg': '#1F2937',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="dashboard-container flex">

        <!-- Sidebar Navigation (Conditionally rendered/hidden based on role) -->
        <aside id="sidebar" class="w-64 bg-sidebar-bg text-white flex-col p-4 shadow-xl transition-all duration-300 ease-in-out fixed inset-y-0 left-0 z-20 hidden md:flex md:relative md:translate-x-0 -translate-x-full">
            <div class="flex items-center justify-center h-16 border-b border-gray-700 mb-6">
                <div class="flex items-center text-primary">
                    <i data-lucide="heart-pulse" class="w-7 h-7 mr-2"></i>
                    <span class="text-2xl font-extrabold tracking-wider">HOSPITAL OS</span>
                </div>
            </div>

            <!-- Role-specific Navigation Links -->
            <nav id="nav-links" class="flex-grow space-y-2">
                <!-- Links injected by JS after login -->
            </nav>

            <!-- User Info / Logout -->
            <div class="mt-8 pt-4 border-t border-gray-700">
                <p id="user-role-display" class="text-sm font-semibold text-gray-400 mb-1">Role: N/A</p>
                <div id="user-id-display" class="break-all text-sm text-gray-300 bg-gray-700 p-2 rounded-lg cursor-pointer hover:bg-gray-600 transition" title="Logged in as">
                    Welcome!
                </div>
                <button id="logout-btn" class="mt-4 w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition duration-150 ease-in-out flex items-center justify-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 overflow-y-auto z-10 relative">

            <!-- Mobile Menu Button (Initially hidden, shown after login) -->
            <button id="menu-button" class="hidden md:hidden p-2 rounded-lg bg-white shadow-md text-gray-800 fixed top-4 left-4 z-30">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>

            <!-- Notification/Loading Container -->
            <div id="message-container" class="fixed top-4 right-4 z-50 space-y-2">
                <!-- Messages will appear here -->
            </div>
            <div id="loading-indicator" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-40">
                <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-3">
                    <div class="spinner"></div>
                    <span class="text-gray-700 font-semibold">Processing...</span>
                </div>
            </div>

            <!-- View Containers -->
            <div id="login-view" class="view min-h-full flex items-center justify-center">
                <!-- Login UI injected by JS -->
            </div>
            <div id="hospital-view" class="view hidden"></div> 
            <div id="doctor-view" class="view hidden"></div>
            <div id="staff-view" class="view hidden"></div>
            <div id="patient-view" class="view hidden"></div>

        </main>
    </div>

    <!-- Application Logic -->
    <script>
        // --- 1. STATE AND DATA MANAGEMENT (USING LOCAL STORAGE) ---

        const STORAGE_KEY = 'hms_local_data';

        let currentState = {
            isLoggedIn: false,
            role: null, 
            user: null, 
            subRole: null, 
            subUser: null, 
            currentHospitalId: null
        };
        
        let patientBookingState = {
            selectedCity: null,
            selectedHospitalId: null,
            selectedDoctorId: null
        };
        
        let hospitalSubView = 'dashboard';
        let staffSubView = 'dashboard';
        let doctorSubView = 'dashboard';

        const INITIAL_DATA_STRUCTURE = {
            hospitals: [],
            doctors: [],
            staff: [],
            patients: [],
            appointments: [],
            vehicles: [
                { id: 'V1', name: 'Ambulance 101', type: 'Emergency', isAvailable: true },
                { id: 'V2', name: 'Patient Transport Van', type: 'Routine', isAvailable: true },
            ],
            // Only define cities here for initial list, hospitals array will populate the final structure
            cities: [
                { name: 'Mumbai', hospitals: [] },
                { name: 'Bangalore', hospitals: [] },
                { name: 'Pune', hospitals: [] },
                { name: 'Hyderabad', hospitals: [] }
            ],
            admittedPatients: [], // {patientId, hospitalId, doctorId}
            notifications: []
        };
        
        /**
         * Generates a simple unique ID.
         */
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * CRITICAL FIX: Dynamically rebuilds the 'cities' structure based on the current 'hospitals' list.
         */
        function rebuildCityData(data) {
            // 1. Map all existing hospitals to their city
            const hospitalMap = data.hospitals.reduce((acc, hospital) => {
                if (!acc[hospital.city]) {
                    acc[hospital.city] = [];
                }
                acc[hospital.city].push({ id: hospital.id, name: hospital.name });
                return acc;
            }, {});

            // 2. Start with the list of static cities (to ensure all cities are listed)
            let newCities = JSON.parse(JSON.stringify(INITIAL_DATA_STRUCTURE.cities));

            // 3. Update or add cities based on hospital data
            Object.keys(hospitalMap).forEach(cityName => {
                let cityObj = newCities.find(c => c.name === cityName);
                
                if (!cityObj) {
                    cityObj = { name: cityName, hospitals: [] };
                    newCities.push(cityObj);
                }
                
                // Replace or update the hospital list for this city
                cityObj.hospitals = hospitalMap[cityName];
            });

            data.cities = newCities.filter(c => c.hospitals.length > 0); // Only show cities that have hospitals
        }
        
        /**
         * Initializes or loads data from localStorage.
         */
        function initializeData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            let data;
            if (storedData) {
                data = JSON.parse(storedData);
            } else {
                // Initial Data Setup for Demo
                data = JSON.parse(JSON.stringify(INITIAL_DATA_STRUCTURE)); // Deep copy

                const initialHospitals = [
                    { id: 'HOSP_A', username: 'hospital_mumbai', password: '123', name: 'City General Hospital', city: 'Mumbai', adminName: 'Admin Jane' },
                    { id: 'HOSP_C', username: 'hospital_clinic', password: '123', name: 'Global Care Clinic', city: 'Mumbai', adminName: 'Admin Tom' },
                    { id: 'HOSP_B', username: 'hospital_bangalore', password: '123', name: 'Tech City Care', city: 'Bangalore', adminName: 'Admin Ben' },
                ];
                const initialDoctors = [
                    { id: 'DR1', name: 'Dr. Jane Smith', intro: 'Cardiology Specialist.', hospitalId: 'HOSP_A', isOpd: false, isAvailable: false, username: 'drsmith' },
                    { id: 'DR2', name: 'Dr. Alex Jones', intro: 'General Physician, Routine Checkups.', hospitalId: 'HOSP_A', isOpd: false, isAvailable: true, username: 'drjones' },
                    { id: 'DR3', name: 'Dr. Ben Lee', intro: 'Orthopedic Surgeon, Emergency Trauma.', hospitalId: 'HOSP_B', isOpd: false, isAvailable: true, username: 'drlee' },
                ];
                const initialStaff = [
                    { id: 'STF1', name: 'Receptionist A', hospitalId: 'HOSP_A', username: 'staffa' },
                    { id: 'STF2', name: 'Admin B', hospitalId: 'HOSP_B', username: 'staffb' },
                ];
                const initialPatients = [
                    { id: 'P001', username: 'patient1', password: '123', name: 'Ravi Sharma', age: 35, weight: 75, city: 'Mumbai', currentDoctorId: 'DR2', isAdmitted: false, condition: 'Fever', isPaymentVerified: true, prescriptions: [{ date: new Date().toLocaleDateString(), medicine: 'Paracetamol', dosage: '500mg', doctor: 'Dr. Alex Jones' }] },
                    { id: 'P002', username: 'patient2', password: '123', name: 'Priya Verma', age: 50, weight: 62, city: 'Mumbai', currentDoctorId: 'DR1', isAdmitted: true, condition: 'Chest Pain', isPaymentVerified: true, prescriptions: [] },
                ];
                const now = new Date().toISOString().split('T')[0];
                const initialAppointments = [
                    { id: generateId(), patientId: 'P001', doctorId: 'DR2', hospitalId: 'HOSP_A', date: now, time: '10:00', status: 'Booked', paymentStatus: 'Paid', waitingListPos: 1, name: 'Ravi Sharma' },
                    { id: generateId(), patientId: generateId(), doctorId: 'DR2', hospitalId: 'HOSP_A', date: now, time: '10:30', status: 'Booked', paymentStatus: 'Paid', waitingListPos: 2, name: 'Sanjay Dutt' }
                ];
                const initialAdmitted = [
                    { patientId: 'P002', hospitalId: 'HOSP_A', doctorId: 'DR1' }
                ];

                data.hospitals = initialHospitals;
                data.doctors = initialDoctors;
                data.staff = initialStaff;
                data.patients = initialPatients;
                data.appointments = initialAppointments;
                data.admittedPatients = initialAdmitted;
            }
            
            // CRITICAL FIX: Rebuild the dynamic city structure from the stored hospitals data
            rebuildCityData(data);
            saveData(data); 
            return data;
        }

        /**
         * Saves the current data state to localStorage.
         */
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        /**
         * Loads data from localStorage.
         */
        function loadData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY));
        }
        
        // --- End Data Management ---

        // --- 2. UI UTILITIES ---

        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const successColor = '#16A34A'; 
            const errorColor = 'bg-red-500';
            const warningColor = 'bg-yellow-500';

            const colorClass = type === 'success' ? `bg-[${successColor}]` : type === 'error' ? errorColor : warningColor;
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'info';

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-xl shadow-xl text-white font-semibold flex items-center ${colorClass} transition duration-300 transform translate-x-0 opacity-100`;
            messageDiv.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5 mr-3"></i>
                <span>${message}</span>
                <button class="ml-4 text-white hover:opacity-80 close-btn" data-lucide="x"></button>
            `;

            container.appendChild(messageDiv);
            lucide.createIcons();

            const closeButton = messageDiv.querySelector('.close-btn');
            closeButton.addEventListener('click', () => {
                messageDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => messageDiv.remove(), 300);
            });

            setTimeout(() => {
                messageDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => messageDiv.remove(), 300);
            }, 7000); 
        }

        function setLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
        }

        // --- 3. ROUTER AND VIEW RENDERING ---

        /**
         * Switches the active application view (and sub-view if applicable).
         */
        function switchView(viewId, navId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('nav-active');
            });
            if (navId) {
                document.querySelector(`.nav-item[data-nav="${navId}"]`).classList.add('nav-active');
            }
            
            // Set sub-view state based on navId
            if (viewId === 'hospital-view') hospitalSubView = navId;
            if (viewId === 'doctor-view') doctorSubView = navId;
            if (viewId === 'staff-view') staffSubView = navId;

            // Close sidebar on mobile
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }
            
            // Re-render the current view content
            if (viewId === 'hospital-view') renderHospitalDashboard();
            if (viewId === 'doctor-view') renderDoctorDashboard();
            if (viewId === 'staff-view') renderStaffDashboard();
            if (viewId === 'patient-view') renderPatientDashboard();
        }

        /**
         * Renders the navigation bar based on the user role.
         */
        function renderNavigation() {
            const navLinks = document.getElementById('nav-links');
            const role = currentState.role;
            const subRole = currentState.subRole;
            let links = [];

            if (!role) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('menu-button').classList.add('hidden');
                return;
            }

            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('menu-button').classList.remove('hidden');
            
            // Display User Info
            const displayName = currentState.subUser ? currentState.subUser.name : currentState.user.name;
            const displayRole = currentState.subRole || currentState.role;
            const hospitalName = currentState.user.name;

            document.getElementById('user-role-display').textContent = `Role: ${displayRole.charAt(0).toUpperCase() + displayRole.slice(1)} | ${hospitalName}`;
            document.getElementById('user-id-display').textContent = `${displayName}`;


            if (role === 'hospital' && !subRole) {
                // Hospital Admin (Main Hospital Account) Links
                links = [
                    { id: 'dashboard', view: 'hospital-view', icon: 'layout-dashboard', text: 'Hospital Dashboard' },
                    { id: 'manage-personnel', view: 'hospital-view', icon: 'users', text: 'Manage Personnel' },
                    { id: 'sub-login', view: 'hospital-view', icon: 'log-in', text: 'Sub-User Login' }
                ];
            } else if (subRole === 'doctor') {
                // Doctor Links
                links = [
                    { id: 'doc-dashboard', view: 'doctor-view', icon: 'layout-dashboard', text: 'Dashboard' },
                    { id: 'doc-normal', view: 'doctor-view', icon: 'stethoscope', text: 'Normal Patients' },
                    { id: 'doc-admitted', view: 'doctor-view', icon: 'bed', text: 'Admitted Patients' },
                    { id: 'doc-prescribe', view: 'doctor-view', icon: 'book-open', text: 'Prescribe' }
                ];
            } else if (subRole === 'staff') {
                // Staff Links
                links = [
                    { id: 'staff-dashboard', view: 'staff-view', icon: 'layout-dashboard', text: 'Dashboard' },
                    { id: 'staff-manage', view: 'staff-view', icon: 'clipboard-check', text: 'Manage Appointments' },
                    { id: 'staff-discharge', view: 'staff-view', icon: 'wallet', text: 'Payment Verification' }
                ];
            } else if (role === 'patient') {
                // Patient Links
                links = [
                    { id: 'patient-dashboard', view: 'patient-view', icon: 'home', text: 'Dashboard' },
                    { id: 'patient-book', view: 'patient-view', icon: 'calendar-plus', text: 'Book Appointment' },
                    { id: 'patient-waiting', view: 'patient-view', icon: 'list-ordered', text: 'My Waiting List' },
                    { id: 'patient-vehicle', view: 'patient-view', icon: 'car', text: 'Book Vehicle' },
                    { id: 'patient-records', view: 'patient-view', icon: 'clipboard-list', text: 'My Records' }
                ];
            }

            navLinks.innerHTML = links.map(link => {
                const isActive = (link.id === hospitalSubView || link.id === doctorSubView || link.id === staffSubView);
                return `
                <a href="#" data-view="${link.view}" data-nav="${link.id}" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out ${isActive ? 'nav-active' : ''}">
                    <i data-lucide="${link.icon}" class="w-5 h-5 mr-3"></i>
                    <span>${link.text}</span>
                </a>
            `}).join('');

            lucide.createIcons();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(item.getAttribute('data-view'), item.getAttribute('data-nav'));
                });
            });

            // Set initial active view if not already set (e.g., after initial login)
            let initialViewId = (subRole === 'doctor' ? 'doctor-view' : subRole === 'staff' ? 'staff-view' : role === 'hospital' ? 'hospital-view' : 'patient-view');
            let initialNavId = subRole === 'doctor' ? 'doc-dashboard' : subRole === 'staff' ? 'staff-dashboard' : role === 'hospital' ? 'dashboard' : 'patient-dashboard';
            
            // Prevent re-rendering dashboard unnecessarily
            if (document.getElementById(initialViewId).classList.contains('hidden')) {
                 switchView(initialViewId, initialNavId);
            }
        }

        // --- 4. AUTHENTICATION (Login/Logout) ---

        /**
         * Renders the login form UI.
         */
        function renderLogin() {
            const loginView = document.getElementById('login-view');
            loginView.innerHTML = `
                <div class="w-full max-w-lg">
                    <!-- HOSPITAL IMAGE HEADER -->
                    <img src="https://placehold.co/600x160/4c8cc4/ffffff?text=Professional+Hospital+Services" 
                         alt="Hospital building exterior" 
                         class="w-full rounded-t-xl shadow-xl object-cover h-32 md:h-40">
                    
                    <!-- Main Login Card - Adjusted rounded corners for image header -->
                    <div class="bg-white p-8 md:p-10 rounded-b-xl shadow-2xl border-b-8 border-primary">
                        
                        <!-- Large Professional Title -->
                        <div class="flex flex-col items-center mb-6 pt-4 border-b pb-4 border-gray-100">
                            <i data-lucide="heart-pulse" class="w-12 h-12 text-primary mb-3"></i>
                            <h1 class="text-5xl font-extrabold text-primary text-center tracking-tight">HOSPITAL MANAGEMENT</h1>
                            <p class="text-xl font-semibold text-gray-600 mt-2">SYSTEM ACCESS PORTAL</p>
                        </div>
                        <p class="text-gray-500 mb-6 text-center">Select your account type or register below.</p>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button data-role="hospital" class="role-btn p-3 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary hover:text-white transition duration-200">Hospital (Admin)</button>
                            <button data-role="patient" class="role-btn p-3 rounded-lg border-2 border-gray-400 text-gray-600 font-semibold hover:bg-gray-700 hover:text-white transition duration-200">Patient</button>
                        </div>

                        <form id="login-form" class="space-y-4">
                            <input type="hidden" id="login-role" required>
                            <div id="login-fields" class="space-y-4">
                                <!-- Fields dynamically injected here -->
                            </div>
                            <button type="submit" id="submit-login" class="w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary-dark transition duration-150 ease-in-out shadow-lg opacity-50 cursor-not-allowed" disabled>
                                Select Role to Log In
                            </button>
                        </form>
                    </div>
                    
                    <!-- Registration Options -->
                    <div class="mt-4 p-4 bg-white rounded-xl shadow-lg border-t border-gray-200">
                        <p class="font-bold text-lg mb-2 text-primary">New Users</p>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="register-hospital-btn" class="bg-yellow-500 text-white font-semibold py-2 rounded-lg hover:bg-yellow-600 transition">Register Hospital</button>
                            <button id="register-patient-btn" class="bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition">Register Patient</button>
                        </div>
                        <p class="mt-4 text-xs text-gray-500">Demo Credential Example: Hospital Username: hospital_mumbai | Patient Username: patient1 (Password: 123 for all)</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
            attachLoginEventListeners();
            updateLoginButtonState();
        }

        /**
         * Updates the state and text of the login button.
         */
        function updateLoginButtonState() {
            const btn = document.getElementById('submit-login');
            const roleInput = document.getElementById('login-role');
            if (!btn || !roleInput) return;

            const roleSelected = !!roleInput.value;

            if (roleSelected) {
                btn.disabled = false;
                btn.textContent = 'Log In';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.textContent = 'Select Role to Log In';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Updates the login form fields based on the selected role.
         */
        function updateLoginFields(role) {
            const fieldsContainer = document.getElementById('login-fields');
            let fields = [
                '<input type="text" id="username" placeholder="Username" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">',
                '<input type="password" id="password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">',
                '<input type="text" id="city" placeholder="City Name" required value="Mumbai" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">',
            ];

            fieldsContainer.innerHTML = fields.join('');
            updateLoginButtonState();
        }

        /**
         * Handles the main login attempt.
         */
        function handleLogin(e) {
            e.preventDefault();
            setLoading(true);

            const role = document.getElementById('login-role').value;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const city = document.getElementById('city').value.trim();

            let user = null;
            const data = loadData();

            if (role === 'hospital') {
                user = data.hospitals.find(h => 
                    h.username === username && 
                    h.password === password && 
                    h.city === city
                );
            } else if (role === 'patient') {
                user = data.patients.find(p => p.username === username && p.password === password && p.city === city);
            }

            if (user) {
                currentState.isLoggedIn = true;
                currentState.role = role;
                currentState.user = user;
                currentState.currentHospitalId = user.id;

                showMessage(`Welcome, ${user.name || user.username}! Logging you in as a ${role}.`, 'success');
                renderApplication(); 
            } else {
                showMessage('Login failed. Please check your credentials and city.', 'error');
            }

            setLoading(false);
        }

        /**
         * Handles the logout action.
         */
        function handleLogout() {
            // Update Doctor OPD status if sub-user was a doctor
            if (currentState.subRole === 'doctor') {
                const data = loadData();
                const doctor = data.doctors.find(d => d.id === currentState.subUser.id);
                if (doctor) {
                    doctor.isOpd = false;
                    saveData(data);
                }
            }
            
            // Clear view content immediately on logout
            document.getElementById('hospital-view').innerHTML = '';
            document.getElementById('doctor-view').innerHTML = '';
            document.getElementById('staff-view').innerHTML = '';
            document.getElementById('patient-view').innerHTML = '';
            
            // If sub-user logs out, return to hospital admin sub-login
            if (currentState.subRole) {
                currentState.subRole = null;
                currentState.subUser = null;
                hospitalSubView = 'sub-login'; // Direct to sub-login page
                showMessage('Personnel logged out. Select a role to log in again.', 'warning');
            } else {
                // If main user (Hospital Admin or Patient) logs out, return to main login
                currentState = { isLoggedIn: false, role: null, user: null, subRole: null, subUser: null, currentHospitalId: null };
                hospitalSubView = 'dashboard';
                showMessage('You have been logged out successfully.', 'success');
            }

            doctorSubView = 'dashboard';
            staffSubView = 'dashboard';
            patientBookingState = { selectedCity: null, selectedHospitalId: null, selectedDoctorId: null };
            
            renderApplication(); 
        }

        /**
         * Attaches listeners for the login view.
         */
        function attachLoginEventListeners() {
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.replace('border-primary', 'border-gray-400'));
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.replace('text-primary', 'text-gray-600'));
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.replace('hover:bg-primary', 'hover:bg-gray-700'));

                    btn.classList.replace('border-gray-400', 'border-primary');
                    btn.classList.replace('text-gray-600', 'text-primary');
                    btn.classList.replace('hover:bg-gray-700', 'hover:bg-primary');
                    
                    const role = btn.getAttribute('data-role');
                    document.getElementById('login-role').value = role;
                    updateLoginFields(role);
                });
            });

            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-hospital-btn').addEventListener('click', () => openRegistrationModal('hospital'));
            document.getElementById('register-patient-btn').addEventListener('click', () => openRegistrationModal('patient'));
        }
        
        // --- 5. REGISTRATION MODALS ---

        /**
         * Opens the modal for Hospital or Patient registration.
         */
        function openRegistrationModal(type) {
            const isHospital = type === 'hospital';
            const title = isHospital ? 'Register New Hospital Account' : 'Register New Patient Account';
            
            const extraFields = isHospital ? `
                <input type="text" id="reg-hospital-name" placeholder="Hospital Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                <input type="text" id="reg-admin-name" placeholder="Administrator Full Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
            ` : `
                <input type="text" id="reg-patient-name" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                <input type="number" id="reg-patient-age" placeholder="Age" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                <input type="number" id="reg-patient-weight" placeholder="Weight (kg)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
            `;
            const data = loadData();
            // Using the full city list from the structure for registration
            const cityOptions = INITIAL_DATA_STRUCTURE.cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            const modalHtml = `
                <div id="registration-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">${title}</h3>
                        <form id="registration-form" data-type="${type}" class="space-y-3">
                            ${extraFields}
                            <input type="text" id="reg-username" placeholder="Choose Username" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="password" id="reg-password" placeholder="Choose Password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <select id="reg-city" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                                <option value="" disabled selected>Select City</option>
                                ${cityOptions}
                            </select>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="close-reg-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                <button type="submit" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition">Register</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('close-reg-modal-btn').addEventListener('click', () => document.getElementById('registration-modal').remove());
            document.getElementById('registration-form').addEventListener('submit', handleRegistration);
        }

        /**
         * Handles the submission of the registration forms.
         */
        function handleRegistration(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.getAttribute('data-type');
            const data = loadData();

            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const city = document.getElementById('reg-city').value;

            // Basic check for existing username
            const isUsernameTaken = data.hospitals.some(h => h.username === username) || data.patients.some(p => p.username === username);
            if (isUsernameTaken) {
                showMessage('Username already taken. Please choose another.', 'error');
                return;
            }

            if (type === 'hospital') {
                const name = document.getElementById('reg-hospital-name').value.trim();
                const adminName = document.getElementById('reg-admin-name').value.trim();
                
                const newId = 'HOSP_' + generateId().toUpperCase().slice(1, 4);
                const newHospital = {
                    id: newId,
                    username,
                    password,
                    name,
                    city,
                    adminName
                };
                data.hospitals.push(newHospital);
                
                // FIX: Rebuild city data dynamically after adding new hospital
                rebuildCityData(data);

                showMessage(`Hospital ${name} registered successfully! ID: ${newId}.`, 'success');
            } else if (type === 'patient') {
                const name = document.getElementById('reg-patient-name').value.trim(); 
                const age = document.getElementById('reg-patient-age').value.trim();
                const weight = document.getElementById('reg-patient-weight').value.trim();
                
                const newId = 'P' + generateId().toUpperCase().slice(1, 6);
                const newPatient = {
                    id: newId,
                    username,
                    password,
                    name,
                    age: Number(age),
                    weight: Number(weight),
                    city,
                    currentDoctorId: null,
                    isAdmitted: false,
                    condition: 'New Patient Registration',
                    isPaymentVerified: true,
                    prescriptions: []
                };
                data.patients.push(newPatient);
                showMessage(`Patient account for ${name} registered successfully!`, 'success');
            }

            saveData(data);
            document.getElementById('registration-modal').remove();
        }

        // --- 6. CORE LOGIC ---

        /**
         * Simulates sending a staff notification.
         */
        function staffNotification(message, hospitalId) {
            const data = loadData();
            data.notifications.push({ id: generateId(), role: 'staff', message, hospitalId, timestamp: Date.now() });
            saveData(data);
            showMessage(message, 'warning'); // Show to current user if they are staff/admin
        }
        
        /**
         * Adds a new doctor record.
         */
        function addDoctor(name, username, hospitalId, intro, adminPassword) {
            const data = loadData();
            const hospital = data.hospitals.find(h => h.id === hospitalId);

            // ADMIN PASSWORD GATE
            if (hospital.password !== adminPassword) {
                showMessage('Personnel creation failed: Invalid Hospital Admin Password.', 'error');
                return;
            }

            const newDocId = 'DR' + generateId().toUpperCase().slice(1, 4);
            

            const newDoc = {
                id: newDocId,
                username: username,
                name: name,
                intro: intro,
                hospitalId: hospitalId,
                city: hospital.city,
                isOpd: false,
                isAvailable: false
            };
            data.doctors.push(newDoc);
            saveData(data);
            showMessage(`New Doctor ${name} (${newDocId}) added successfully! Username: ${username}`, 'success');
        }

        /**
         * Adds a new staff record.
         */
        function addStaff(name, username, hospitalId, adminPassword) {
            const data = loadData();
            const hospital = data.hospitals.find(h => h.id === hospitalId);
            
            // ADMIN PASSWORD GATE
            if (hospital.password !== adminPassword) {
                showMessage('Personnel creation failed: Invalid Hospital Admin Password.', 'error');
                return;
            }

            const newStaffId = 'STF' + generateId().toUpperCase().slice(1, 4);
            const newStaff = {
                id: newStaffId,
                username: username,
                name: name,
                hospitalId: hospitalId,
                city: hospital.city
            };
            data.staff.push(newStaff);
            saveData(data);
            showMessage(`New Staff ${name} (${newStaffId}) added successfully! Username: ${username}`, 'success');
        }

        /**
         * Patient action: Book a new appointment.
         */
        function handleAppointmentBooking(patientId, doctorId, hospitalId, date, time, name, age, weight) {
            simulateUpiPayment((success) => {
                if (!success) return;

                const data = loadData();
                // Use the data array directly for synchronous filtering
                const targetAppointments = data.appointments.filter(app => app.doctorId === doctorId && app.date === date);
                const waitingListPos = targetAppointments.length + 1;

                data.appointments.push({
                    id: generateId(),
                    patientId,
                    doctorId,
                    hospitalId,
                    date,
                    time,
                    name,
                    age: Number(age),
                    weight: Number(weight),
                    status: 'Booked',
                    paymentStatus: 'Paid',
                    waitingListPos
                });

                // Update patient's last doctor/hospital for record keeping
                const patient = data.patients.find(p => p.id === patientId);
                if (patient) {
                    patient.currentDoctorId = doctorId;
                }
                
                saveData(data);
                showMessage(`Appointment booked! Your position on the waiting list is #${waitingListPos} on ${date}.`, 'success');
                renderPatientDashboard();
            });
        }
        
        /**
         * Simulates UPI payment confirmation (Synchronous version).
         */
        function simulateUpiPayment(callback) {
            setLoading(true);
            setTimeout(() => {
                setLoading(false);
                const success = Math.random() > 0.1; // 90% success rate
                if (success) {
                    showMessage('UPI Payment confirmed. Thank you!', 'success');
                    callback(true);
                } else {
                    showMessage('UPI Payment failed. Please try again.', 'error');
                    callback(false);
                }
            }, 1500);
        }

        /**
         * Moves a patient to the admitted list (Doctor only).
         */
        function admitPatient(patientId) {
            const data = loadData();
            const patient = data.patients.find(p => p.id === patientId);
            const appointment = data.appointments.find(app => app.patientId === patientId);

            if (!patient || patient.isAdmitted) {
                showMessage('Patient already admitted or not found.', 'error');
                return;
            }
            
            // 1. Update Patient status
            patient.isAdmitted = true;

            // 2. Add to admittedPatients list
            data.admittedPatients.push({ 
                patientId, 
                hospitalId: currentState.currentHospitalId, 
                doctorId: patient.currentDoctorId 
            });

            // 3. Remove appointment (if it exists)
            if (appointment) {
                data.appointments = data.appointments.filter(app => app.id !== appointment.id);
            }

            saveData(data);
            showMessage(`${patient.name} has been moved to the Admitted Patient list.`, 'warning');
            renderDoctorDashboard();
            renderStaffDashboard();
        }

        /**
         * Handles the Doctor's prescription action.
         */
        function handlePrescription(patientId, medicine, dosage) {
            const data = loadData();
            const patient = data.patients.find(p => p.id === patientId);

            if (!patient) {
                showMessage('Patient not found.', 'error');
                return;
            }
            
            const newPrescription = {
                date: new Date().toLocaleDateString(),
                doctor: currentState.subUser.name,
                medicine,
                dosage
            };
            
            patient.prescriptions.push(newPrescription);
            saveData(data);
            
            showMessage(`Prescription for ${patient.name} saved successfully!`, 'success');
        }

        // --- 7. ROLE-SPECIFIC DASHBOARD RENDERERS ---

        /**
         * Renders the Hospital Admin Dashboard (Hospital-view).
         */
        function renderHospitalDashboard() {
            const view = document.getElementById('hospital-view');
            const data = loadData();
            const hospital = currentState.user;
            const myDoctors = data.doctors.filter(d => d.hospitalId === hospital.id);
            const myStaff = data.staff.filter(s => s.hospitalId === hospital.id);

            let content = '';

            if (hospitalSubView === 'dashboard') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary"></i> ${hospital.name} Dashboard
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                            <p class="text-lg font-medium text-gray-500">Total Doctors</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${myDoctors.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-lg font-medium text-gray-500">Hospital Staff</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${myStaff.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <p class="text-lg font-medium text-gray-500">Admitted Patients</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${data.admittedPatients.filter(a => a.hospitalId === hospital.id).length}</p>
                        </div>
                    </div>
                `;
            } else if (hospitalSubView === 'manage-personnel') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="users" class="w-7 h-7 mr-3 text-primary"></i> Manage Personnel
                    </h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Add Doctor Form -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-primary">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Add New Doctor</h2>
                            <form id="add-doctor-form" class="space-y-3">
                                <input type="text" id="new-doc-name" placeholder="Doctor Full Name" required class="w-full p-3 border rounded-lg">
                                <input type="text" id="new-doc-username" placeholder="Username (for Sub-Login)" required class="w-full p-3 border rounded-lg">
                                <textarea id="new-doc-intro" placeholder="Brief Introduction/Specialization" required class="w-full p-3 border rounded-lg h-20"></textarea>
                                <hr class="my-2 border-gray-200">
                                <input type="password" id="admin-pass-doc" placeholder="Admin Password (Required)" required class="w-full p-3 border rounded-lg border-red-300">
                                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-primary-dark transition">Add Doctor</button>
                            </form>
                        </div>

                        <!-- Add Staff Form -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-primary">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Add New Hospital Staff</h2>
                            <form id="add-staff-form" class="space-y-3">
                                <input type="text" id="new-staff-name" placeholder="Staff Full Name" required class="w-full p-3 border rounded-lg">
                                <input type="text" id="new-staff-username" placeholder="Username (for Sub-Login)" required class="w-full p-3 border rounded-lg">
                                <hr class="my-2 border-gray-200">
                                <input type="password" id="admin-pass-staff" placeholder="Admin Password (Required)" required class="w-full p-3 border rounded-lg border-red-300">
                                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-primary-dark transition">Add Staff</button>
                            </form>
                        </div>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">Current Personnel</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                         <h3 class="text-xl font-semibold mb-3">Doctors (${myDoctors.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${myDoctors.map(d => `<div class="p-3 border rounded-lg bg-gray-50">
                                <p class="font-bold">${d.name} (${d.id})</p>
                                <p class="text-sm text-gray-600">User: ${d.username} | Status: ${d.isAvailable ? 'Available' : 'Unavailable'}</p>
                            </div>`).join('')}
                        </div>
                         <h3 class="text-xl font-semibold mb-3 mt-6">Staff (${myStaff.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${myStaff.map(s => `<div class="p-3 border rounded-lg bg-gray-50">
                                <p class="font-bold">${s.name} (${s.id})</p>
                                <p class="text-sm text-gray-600">User: ${s.username}</p>
                            </div>`).join('')}
                        </div>
                    </div>

                `;
            } else if (hospitalSubView === 'sub-login') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="log-in" class="w-7 h-7 mr-3 text-primary"></i> Personnel Access Login
                    </h1>
                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-xl mx-auto">
                        <p class="text-lg font-semibold text-gray-700 mb-4">Log in as Doctor or Staff to access operational tools for ${currentState.user.name}.</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button data-sub-role="doctor" class="sub-role-btn p-3 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary hover:text-white transition duration-200">Doctor</button>
                            <button data-sub-role="staff" class="sub-role-btn p-3 rounded-lg border-2 border-gray-400 text-gray-600 font-semibold hover:bg-gray-700 hover:text-white transition duration-200">Hospital Staff</button>
                        </div>
                        
                        <form id="sub-login-form" class="space-y-4">
                            <input type="hidden" id="sub-login-role" required>
                            <input type="text" id="sub-username" placeholder="Username (e.g., drsmith or staffa)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <button type="submit" id="submit-sub-login" class="w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary-dark transition shadow-md opacity-50 cursor-not-allowed" disabled>
                                Select Role & Login
                            </button>
                        </form>
                    </div>
                `;
            }

            view.innerHTML = content;
            lucide.createIcons();
            attachHospitalListeners(view);
        }
        
        // --- Doctor Dashboard ---

        function renderDoctorDashboard() {
            const view = document.getElementById('doctor-view');
            const data = loadData();
            const doctor = currentState.subUser;
            const hospitalId = currentState.currentHospitalId;

            const myAppointments = data.appointments.filter(app => app.doctorId === doctor.id && app.hospitalId === hospitalId);
            const admittedPatientRecords = data.admittedPatients.filter(ap => ap.doctorId === doctor.id && ap.hospitalId === hospitalId);
            const admittedPatients = admittedPatientRecords.map(ap => data.patients.find(p => p.id === ap.patientId)).filter(p => p);


            const currentNav = doctorSubView;

            // ... (Rest of Doctor Dashboard rendering logic, using local array methods) ...

            let content = '';
            
            if (currentNav === 'doc-dashboard') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary"></i> Doctor Dashboard: Dr. ${doctor.name}
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                            <p class="text-lg font-medium text-gray-500">OPD Status</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${doctor.isOpd ? 'ONLINE' : 'OFFLINE'}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-lg font-medium text-gray-500">Normal Patients (Upcoming)</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${myAppointments.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <p class="text-lg font-medium text-gray-500">Admitted Patients</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${admittedPatients.length}</p>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'doc-normal') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="stethoscope" class="w-7 h-7 mr-3 text-primary"></i> Normal Patients (Appointments)
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div class="overflow-x-auto">
                            ${myAppointments.length === 0 ? '<p class="p-4 text-center text-gray-500">No normal patients currently scheduled.</p>' : ''}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Appointment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${myAppointments.map(app => {
                                        const patient = data.patients.find(p => p.id === app.patientId) || { name: app.name, condition: 'N/A' };
                                        return `
                                        <tr class="hover:bg-gray-50 transition duration-150">
                                            <td class="px-6 py-4 font-medium text-gray-900">${app.name} (${patient.condition})</td>
                                            <td class="px-6 py-4 text-gray-500">${app.date} at ${app.time} (#${app.waitingListPos})</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button data-id="${patient.id}" class="admit-btn bg-yellow-100 text-yellow-800 p-2 rounded-lg hover:bg-yellow-200 transition">Admit</button>
                                                <button data-id="${patient.id}" class="prescribe-btn bg-primary text-white p-2 rounded-lg hover:bg-primary-dark transition">Prescribe</button>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'doc-admitted') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="bed" class="w-7 h-7 mr-3 text-primary"></i> Admitted Patients
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div class="overflow-x-auto">
                            ${admittedPatients.length === 0 ? '<p class="p-4 text-center text-gray-500">No patients currently admitted.</p>' : ''}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age/Condition</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${admittedPatients.map(p => `
                                        <tr class="hover:bg-gray-50 transition duration-150">
                                            <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                                            <td class="px-6 py-4 text-gray-500">${p.age} / ${p.condition}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button data-id="${p.id}" class="discharge-btn bg-red-100 text-red-800 p-2 rounded-lg hover:bg-red-200 transition">Discharge</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'doc-prescribe') {
                 content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="book-open" class="w-7 h-7 mr-3 text-primary"></i> Write Prescription
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200 max-w-2xl">
                        <form id="prescription-form" class="space-y-4">
                            <select id="prescribe-patient-id" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                                <option value="" disabled selected>Select Patient to Prescribe To</option>
                                ${data.patients.filter(p => p.currentDoctorId === doctor.id).map(p => `<option value="${p.id}">${p.name} (${p.condition})</option>`).join('')}
                            </select>
                            <input type="text" id="prescribe-medicine" placeholder="Medicine Name (e.g., Amoxicillin)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="text" id="prescribe-dosage" placeholder="Dosage (e.g., 500mg, 3 times a day)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary-dark transition shadow-md">
                                <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> Issue Prescription
                            </button>
                        </form>
                    </div>
                `;
            }

            view.innerHTML = content;
            lucide.createIcons();
            attachDoctorListeners();
        }


        // --- Staff Dashboard ---

        function renderStaffDashboard() {
            const view = document.getElementById('staff-view');
            const data = loadData();
            const staff = currentState.subUser;
            const hospitalId = currentState.currentHospitalId;

            const myDoctors = data.doctors.filter(d => d.hospitalId === hospitalId);
            const myDoctorIds = myDoctors.map(d => d.id);
            const myAppointments = data.appointments.filter(app => app.hospitalId === hospitalId);
            
            const admittedPatientRecords = data.admittedPatients.filter(ap => ap.hospitalId === hospitalId);
            const admittedPatients = admittedPatientRecords.map(ap => data.patients.find(p => p.id === ap.patientId)).filter(p => p);
            
            // Patients discharged but pending payment verification
            const dischargedPatients = data.patients.filter(p => !p.isAdmitted && !p.isPaymentVerified && myDoctorIds.includes(p.currentDoctorId));


            const currentNav = staffSubView;
            let content = '';

            if (currentNav === 'staff-dashboard') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="layout-dashboard" class="w-7 h-7 mr-3 text-primary"></i> Staff Dashboard: ${staff.name}
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                            <p class="text-lg font-medium text-gray-500">Active Doctors</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${myDoctors.filter(d => d.isAvailable).length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-lg font-medium text-gray-500">Total Appointments</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${myAppointments.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <p class="text-lg font-medium text-gray-500">Payment Verifications</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-2">${dischargedPatients.length}</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Doctor Availability Management</h2>
                        <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor (ID)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OPD Login</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Availability (Patient View)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${myDoctors.map(d => `
                                        <tr class="hover:bg-gray-50 transition duration-150">
                                            <td class="px-6 py-4 font-medium text-gray-900">${d.name} (${d.id})</td>
                                            <td class="px-6 py-4 text-sm">
                                                <span class="p-1 rounded-full text-white ${d.isOpd ? 'bg-green-500' : 'bg-gray-400'}">${d.isOpd ? 'ONLINE' : 'OFFLINE'}</span>
                                            </td>
                                            <td class="px-6 py-4 text-sm">
                                                <button data-id="${d.id}" data-status="${d.isAvailable}" class="toggle-availability-btn p-2 rounded-lg text-white font-semibold ${d.isAvailable ? 'bg-primary hover:bg-primary-dark' : 'bg-red-500 hover:bg-red-600'} transition">
                                                    ${d.isAvailable ? 'Disable' : 'Enable'}
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'staff-manage') {
                 content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="clipboard-check" class="w-7 h-7 mr-3 text-primary"></i> Patient Management (Appointments & Admitted)
                    </h1>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Normal Patients -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Normal/Appointment List (${myAppointments.length})</h2>
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient / Doctor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${myAppointments.map(app => {
                                            const doctor = myDoctors.find(d => d.id === app.doctorId) || { name: 'Unknown' };
                                            return `
                                            <tr>
                                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${app.name}<br><span class="text-xs text-gray-500">Dr. ${doctor.name}</span></td>
                                                <td class="px-4 py-3 text-sm text-gray-500">${app.date} ${app.time}</td>
                                                <td class="px-4 py-3 text-sm space-y-1">
                                                    <button data-id="${app.id}" class="remove-patient-btn w-full bg-red-100 text-red-800 text-xs p-1 rounded-lg hover:bg-red-200 transition">Remove (No Show)</button>
                                                    <button data-patient-id="${app.patientId}" data-doctor-id="${app.doctorId}" class="transfer-patient-open-btn w-full bg-blue-500 text-white text-xs p-1 rounded-lg hover:bg-blue-600 transition">Transfer</button>
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Admitted Patients -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Admitted Patient List (${admittedPatients.length})</h2>
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient / Doctor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Condition</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${admittedPatients.map(p => {
                                            const doctor = myDoctors.find(d => d.id === p.currentDoctorId) || { name: 'Unknown' };
                                            return `
                                            <tr>
                                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${p.name}<br><span class="text-xs text-gray-500">Dr. ${doctor.name}</span></td>
                                                <td class="px-4 py-3 text-sm text-gray-500">${p.condition}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <button data-patient-id="${p.id}" data-doctor-id="${p.currentDoctorId}" class="transfer-patient-open-btn w-full bg-blue-500 text-white text-xs p-1 rounded-lg hover:bg-blue-600 transition">Transfer</button>
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'staff-discharge') {
                 content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="wallet" class="w-7 h-7 mr-3 text-primary"></i> Payment Verification (Discharged Patients)
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div class="overflow-x-auto">
                            ${dischargedPatients.length === 0 ? '<p class="p-4 text-center text-gray-500">No discharged patients awaiting payment verification.</p>' : ''}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discharged By</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${dischargedPatients.map(p => {
                                        const doctor = myDoctors.find(d => d.id === p.currentDoctorId) || { name: 'N/A' };
                                        return `
                                        <tr class="hover:bg-gray-50 transition duration-150">
                                            <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                                            <td class="px-6 py-4 text-gray-500">Dr. ${doctor.name}</td>
                                            <td class="px-6 py-4 text-red-500 font-semibold">PENDING</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button data-id="${p.id}" class="verify-payment-btn bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition">Verify Payment</button>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }


            view.innerHTML = content;
            lucide.createIcons();
            attachStaffListeners(myDoctors, view);
        }

        /**
         * Renders the Patient Dashboard view.
         */
        function renderPatientDashboard() {
            const view = document.getElementById('patient-view');
            const data = loadData();
            const patient = currentState.user;

            const myAppointments = data.appointments.filter(app => app.patientId === patient.id).sort((a, b) => a.waitingListPos - b.waitingListPos);
            const myRecords = patient.prescriptions || [];
            
            const currentNav = document.querySelector('.nav-item.nav-active')?.getAttribute('data-nav') || 'patient-dashboard';
            let content = '';
            
            // ... (Rest of Patient Dashboard rendering logic) ...

            if (currentNav === 'patient-dashboard') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="home" class="w-7 h-7 mr-3 text-primary"></i> Patient Dashboard
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Welcome, ${patient.name}!</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 border rounded-xl bg-blue-50 border-primary/50">
                                <p class="font-semibold text-primary">Next Appointment</p>
                                <p class="text-lg">${myAppointments[0] ? `${myAppointments[0].date} at ${myAppointments[0].time} (Dr. ${data.doctors.find(d => d.id === myAppointments[0].doctorId)?.name} at ${data.hospitals.find(h => h.id === myAppointments[0].hospitalId)?.name})` : 'No upcoming appointments.'}</p>
                            </div>
                            <div class="p-4 border rounded-xl bg-blue-50 border-blue-200">
                                <p class="font-semibold text-blue-600">Total Prescriptions</p>
                                <p class="text-lg">${myRecords.length} recorded.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentNav === 'patient-book') {
                // --- MULTI-STEP APPOINTMENT BOOKING OVERHAUL ---
                
                const allCities = data.cities;
                const hospitalsInSelectedCity = allCities.find(c => c.name === patientBookingState.selectedCity)?.hospitals || [];
                
                // Filter doctors by selected hospital AND availability
                const availableDoctors = data.doctors.filter(d => 
                    d.isAvailable && 
                    d.hospitalId === patientBookingState.selectedHospitalId
                );

                // Determine current step based on state
                let currentStep = 1;
                if (patientBookingState.selectedCity && patientBookingState.selectedHospitalId && !patientBookingState.selectedDoctorId) {
                    currentStep = 3;
                } else if (patientBookingState.selectedCity && !patientBookingState.selectedHospitalId) {
                    currentStep = 2;
                } else if (patientBookingState.selectedDoctorId) {
                    currentStep = 4;
                }
                
                const getStepClass = (step) => step <= currentStep ? 'bg-primary text-white' : 'bg-gray-200 text-gray-600';
                const getLineClass = (step) => step < currentStep ? 'bg-primary' : 'bg-gray-300';
                
                const selectedHospitalObj = hospitalsInSelectedCity.find(h => h.id === patientBookingState.selectedHospitalId);
                const selectedHospital = selectedHospitalObj?.name || 'N/A';
                const selectedDoctor = availableDoctors.find(d => d.id === patientBookingState.selectedDoctorId)?.name || 'N/A';

                // --- Start Content ---
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="calendar-plus" class="w-7 h-7 mr-3 text-primary"></i> Book Appointment (Step ${currentStep} of 4)
                    </h1>
                    
                    <!-- Progress Bar -->
                    <div class="flex items-center mb-8 justify-between max-w-2xl mx-auto">
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${getStepClass(1)}">1</div>
                            <span class="text-xs mt-1 text-gray-600">City</span>
                        </div>
                        <div class="flex-grow h-1 mx-4 ${getLineClass(2)}"></div>
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${getStepClass(2)}">2</div>
                            <span class="text-xs mt-1 text-gray-600">Hospital</span>
                        </div>
                        <div class="flex-grow h-1 mx-4 ${getLineClass(3)}"></div>
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${getStepClass(3)}">3</div>
                            <span class="text-xs mt-1 text-gray-600">Doctor</span>
                        </div>
                        <div class="flex-grow h-1 mx-4 ${getLineClass(4)}"></div>
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${getStepClass(4)}">4</div>
                            <span class="text-xs mt-1 text-gray-600">Confirm</span>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                `;
                
                // --- Step 1: Select City ---
                if (currentStep === 1) {
                    content += `
                        <h2 class="text-xl font-bold text-primary mb-4">Step 1: Choose Your City</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${allCities.map(c => `
                                <button data-city="${c.name}" class="select-city-btn p-4 rounded-xl border-2 border-gray-300 hover:border-primary transition duration-200 ${patientBookingState.selectedCity === c.name ? 'city-selected' : ''}">
                                    <p class="font-semibold text-gray-800">${c.name}</p>
                                    <p class="text-xs text-gray-500">${c.hospitals.length} Hospitals</p>
                                </button>
                            `).join('')}
                        </div>
                        <p class="text-gray-500 mt-4">Patient's Registered City: <span class="font-bold text-primary">${patient.city}</span></p>
                    `;
                }
                
                // --- Step 2: Select Hospital ---
                else if (currentStep === 2) {
                    content += `
                        <h2 class="text-xl font-bold text-primary mb-4">Step 2: Choose Hospital in ${patientBookingState.selectedCity}</h2>
                        <button id="back-to-city" class="text-sm text-blue-500 hover:underline mb-4">&larr; Change City</button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${hospitalsInSelectedCity.map(h => `
                                <button data-hospital="${h.id}" class="select-hospital-btn p-4 rounded-xl border-2 border-gray-300 hover:border-primary transition duration-200 ${patientBookingState.selectedHospitalId === h.id ? 'city-selected' : ''}">
                                    <p class="font-bold text-lg text-gray-800">${h.name}</p>
                                    <p class="text-sm text-gray-600">ID: ${h.id}</p>
                                </button>
                            `).join('')}
                        </div>
                    `;
                }

                // --- Step 3: Select Doctor ---
                else if (currentStep === 3) {
                    content += `
                        <h2 class="text-xl font-bold text-primary mb-4">Step 3: Choose Doctor at ${selectedHospital}</h2>
                        <button id="back-to-hospital" class="text-sm text-blue-500 hover:underline mb-4">&larr; Change Hospital</button>
                        <div id="doctor-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${availableDoctors.map(d => `
                                <button data-id="${d.id}" class="select-doctor-btn text-left p-4 rounded-xl border-2 border-gray-200 hover:border-primary transition cursor-pointer ${patientBookingState.selectedDoctorId === d.id ? 'city-selected' : ''}">
                                    <p class="font-bold text-lg text-gray-800">${d.name}</p>
                                    <p class="text-sm text-gray-600">${d.intro}</p>
                                    <p class="text-xs text-green-500 font-semibold mt-1">Available</p>
                                </button>
                            `).join('')}
                            ${availableDoctors.length === 0 ? '<p class="text-gray-500 col-span-2">No doctors currently available at this hospital.</p>' : ''}
                        </div>
                    `;
                }
                
                // --- Step 4: Book Appointment ---
                else if (currentStep === 4) {
                    content += `
                        <h2 class="text-xl font-bold text-primary mb-4">Step 4: Confirm Booking Details</h2>
                        <button id="back-to-doctor" class="text-sm text-blue-500 hover:underline mb-4">&larr; Change Doctor</button>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="font-bold text-lg text-blue-800">Booking Summary:</p>
                            <p>Hospital: <span class="font-semibold">${selectedHospital}</span></p>
                            <p>Doctor: <span class="font-semibold">Dr. ${selectedDoctor}</span></p>
                            <p class="text-red-600 font-semibold mt-2">Note: You will see your position on the waiting list ONLY after payment confirmation.</p>
                        </div>
                        
                        <form id="appointment-booking-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg">
                            <input type="hidden" id="booking-doctor-id" value="${patientBookingState.selectedDoctorId}" required>
                            <input type="hidden" id="booking-hospital-id" value="${patientBookingState.selectedHospitalId}" required>

                            <input type="text" id="booking-name" placeholder="Full Name" value="${patient.name}" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="number" id="booking-age" placeholder="Age" value="${patient.age}" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="number" id="booking-weight" placeholder="Weight (kg)" value="${patient.weight}" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="date" id="booking-date" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" min="${new Date().toISOString().split('T')[0]}">
                            <input type="time" id="booking-time" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="number" id="fee" value="500" disabled class="p-3 border border-gray-300 rounded-lg text-gray-500 focus:ring-primary focus:border-primary transition" title="Consultation Fee">
                            <input type="text" id="booking-disease" placeholder="Brief Condition/Symptom" required class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">

                            <button type="submit" id="book-appointment-btn" class="md:col-span-4 bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary-dark transition shadow-md flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-5 h-5 mr-2"></i> Confirm Booking & Pay 500 INR
                            </button>
                        </form>
                    `;
                }

                content += `</div>`; // Close white card
            } else if (currentNav === 'patient-waiting') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="list-ordered" class="w-7 h-7 mr-3 text-primary"></i> My Waiting List Position
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        ${myAppointments.length === 0 ? '<p class="p-4 text-center text-gray-500">You have no upcoming appointments.</p>' : ''}
                        ${myAppointments.map(app => {
                            const doctor = data.doctors.find(d => d.id === app.doctorId);
                            const hospital = data.hospitals.find(h => h.id === app.hospitalId);
                            
                            // Filter waiting list only by Doctor and Date
                            const waitingList = data.appointments.filter(a => a.doctorId === app.doctorId && a.date === app.date).sort((a, b) => a.waitingListPos - b.waitingListPos);
                            const myPosition = waitingList.findIndex(a => a.id === app.id) + 1;

                            return `
                                <div class="p-4 mb-4 border rounded-xl shadow-md ${myPosition === 1 ? 'bg-primary text-white' : 'bg-blue-50 border-blue-200'}">
                                    <p class="text-xl font-bold">Appointment with Dr. ${doctor?.name || 'Unknown Doctor'}</p>
                                    <p class="${myPosition === 1 ? 'text-white' : 'text-gray-600'}">Hospital: ${hospital?.name || 'N/A'}</p>
                                    <p class="${myPosition === 1 ? 'text-white' : 'text-gray-600'}">Date: ${app.date} @ ${app.time}</p>
                                    <p class="mt-2 text-2xl font-extrabold ${myPosition === 1 ? 'text-yellow-300' : 'text-blue-800'}">
                                        Your Position: #${myPosition} out of ${waitingList.length}
                                    </p>
                                    ${myPosition === 1 ? '<p class="mt-2 font-semibold">You are next! Please be ready for consultation.</p>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (currentNav === 'patient-records') {
                 content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="clipboard-list" class="w-7 h-7 mr-3 text-primary"></i> My Medical Records
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Prescription History (${myRecords.length})</h2>
                        ${myRecords.length === 0 ? '<p class="p-4 text-center text-gray-500">No prescriptions found.</p>' : ''}
                        <div class="space-y-4">
                            ${myRecords.map(rec => `
                                <div class="p-4 border rounded-xl bg-gray-50">
                                    <p class="font-bold text-gray-800">${rec.medicine} (${rec.dosage})</p>
                                    <p class="text-sm text-gray-600">Prescribed by Dr. ${rec.doctor || 'N/A'} on ${rec.date}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (currentNav === 'patient-vehicle') {
                content = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
                        <i data-lucide="car" class="w-7 h-7 mr-3 text-primary"></i> Book Transportation
                    </h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Vehicle Booking</h2>
                        <form id="vehicle-booking-form" class="space-y-4 max-w-xl">
                            <input type="text" id="vehicle-from" placeholder="Pick-up Location (From)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <input type="text" id="vehicle-to" placeholder="Drop-off Location (To)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            <select type="text" id="vehicle-type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                                <option value="Routine">Routine Transport Van</option>
                                <option value="Emergency">Ambulance (Emergency)</option>
                            </select>
                            <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-xl hover:bg-blue-600 transition shadow-md flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-5 h-5 mr-2"></i> Book Vehicle & Pay (Simulated UPI)
                            </button>
                        </form>

                        <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4 border-b pb-2">Available Vehicles</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${data.vehicles.map(v => `
                                <div class="p-4 border rounded-xl ${v.isAvailable ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}">
                                    <p class="font-bold text-lg text-gray-800">${v.name}</p>
                                    <p class="text-sm text-gray-600">${v.type} | Status: ${v.isAvailable ? 'Available' : 'In Use'}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }


            view.innerHTML = content;
            lucide.createIcons();
            attachPatientListeners();
        }


        // --- 8. LISTENERS (Hospital, Doctor, Staff, Patient) ---
        
        // Listeners implementation omitted for brevity, but they primarily call the synchronous data functions above.

        function attachHospitalListeners(view) {
            // Add Doctor Form
            document.getElementById('add-doctor-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-doc-name').value.trim();
                const username = document.getElementById('new-doc-username').value.trim();
                const intro = document.getElementById('new-doc-intro').value.trim();
                const adminPassword = document.getElementById('admin-pass-doc').value.trim();
                
                addDoctor(name, username, currentState.user.id, intro, adminPassword);
                e.target.reset();
                renderHospitalDashboard();
            });

            // Add Staff Form
            document.getElementById('add-staff-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-staff-name').value.trim();
                const username = document.getElementById('new-staff-username').value.trim();
                const adminPassword = document.getElementById('admin-pass-staff').value.trim();
                
                addStaff(name, username, currentState.user.id, adminPassword);
                e.target.reset();
                renderHospitalDashboard();
            });
            
            // Sub-Login Form (Doctor/Staff Access)
            document.querySelectorAll('.sub-role-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sub-role-btn').forEach(b => b.classList.replace('border-primary', 'border-gray-400'));
                btn.classList.replace('border-gray-400', 'border-primary');
                const role = btn.getAttribute('data-sub-role');
                document.getElementById('sub-login-role').value = role;
                document.getElementById('submit-sub-login').disabled = false;
                document.getElementById('submit-sub-login').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('submit-sub-login').textContent = `Log In as ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            }));

            document.getElementById('sub-login-form')?.addEventListener('submit', handleSubLogin);
        }

        // Sub-login handler (Doctor/Staff)
        function handleSubLogin(e) {
            e.preventDefault();
            setLoading(true);
            const data = loadData();
            const role = document.getElementById('sub-login-role').value;
            const username = document.getElementById('sub-username').value.trim();
            const hospitalId = currentState.user.id;
            
            let subUser = null;

            if (role === 'doctor') {
                subUser = data.doctors.find(d => d.username === username && d.hospitalId === hospitalId);
            } else if (role === 'staff') {
                subUser = data.staff.find(s => s.username === username && s.hospitalId === hospitalId);
            }

            if (subUser) {
                currentState.subRole = role;
                currentState.subUser = subUser;
                showMessage(`Logged in as ${subUser.name}, ${role}.`, 'success');
                renderApplication();
            } else {
                showMessage(`Login failed. Check the username for this ${role}.`, 'error');
            }
            setLoading(false);
        }

        function attachDoctorListeners() {
            // Toggle Doctor OPD status
            document.querySelectorAll('.admit-btn').forEach(btn => btn.addEventListener('click', (e) => {
                admitPatient(e.currentTarget.getAttribute('data-id'));
            }));
            
            // Handle Discharge (Requires Doctor Role)
            document.querySelectorAll('.discharge-btn').forEach(btn => btn.addEventListener('click', (e) => {
                // Simplified Discharge: Sets isAdmitted=false and isPaymentVerified=false
                const patientId = e.currentTarget.getAttribute('data-id');
                const data = loadData();
                const patient = data.patients.find(p => p.id === patientId);

                if (patient) {
                    patient.isAdmitted = false;
                    patient.isPaymentVerified = false; // Send to staff for verification
                    // Remove from admittedPatients list
                    data.admittedPatients = data.admittedPatients.filter(ap => ap.patientId !== patientId);
                    saveData(data);
                    
                    staffNotification(`Patient ${patient.name} discharged by Dr. ${currentState.subUser.name}. Awaiting payment verification.`, currentState.currentHospitalId);
                    showMessage('Patient discharged. Sent to staff for payment verification.', 'success');
                    renderDoctorDashboard();
                }
            }));
            
            // Prescription Form Submission
            const form = document.getElementById('prescription-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const patientId = document.getElementById('prescribe-patient-id').value;
                    const medicine = document.getElementById('prescribe-medicine').value.trim();
                    const dosage = document.getElementById('prescribe-dosage').value.trim();
                    if (patientId && medicine && dosage) {
                        handlePrescription(patientId, medicine, dosage);
                        form.reset();
                    } else {
                        showMessage('Please fill all prescription fields.', 'error');
                    }
                });
            }
        }

        function attachStaffListeners(doctors, view) {
            // Toggle Doctor Availability
            document.querySelectorAll('.toggle-availability-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const docId = e.currentTarget.getAttribute('data-id');
                const newStatus = e.currentTarget.getAttribute('data-status') === 'false';
                
                const data = loadData();
                const doctor = data.doctors.find(d => d.id === docId);
                if (doctor) {
                    doctor.isAvailable = newStatus;
                    saveData(data);
                    showMessage(`Dr. ${doctor.name}'s availability set to ${newStatus ? 'ON' : 'OFF'}.`, 'warning');
                    renderStaffDashboard(); 
                }
            }));

            // Remove Patient (No Show)
            document.querySelectorAll('.remove-patient-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const appointmentId = e.currentTarget.getAttribute('data-id');
                const data = loadData();
                data.appointments = data.appointments.filter(app => app.id !== appointmentId);
                saveData(data);
                showMessage('Patient removed from the normal list (No Show).', 'warning');
                renderStaffDashboard();
            }));

            // Verify Payment
            document.querySelectorAll('.verify-payment-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const patientId = e.currentTarget.getAttribute('data-id');
                const data = loadData();
                const patient = data.patients.find(p => p.id === patientId);

                if (patient) {
                    patient.isPaymentVerified = true;
                    saveData(data);
                    showMessage(`Payment verified for ${patient.name}. Record cleared.`, 'success');
                    renderStaffDashboard();
                }
            }));
            
            // Transfer Modal Handler (Simplified)
            document.querySelectorAll('.transfer-patient-open-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const patientId = e.currentTarget.getAttribute('data-patient-id');
                const currentDocId = e.currentTarget.getAttribute('data-doctor-id');
                openTransferModal(patientId, currentDocId, doctors);
            }));
        }

        // Transfer Modal (Used by staff)
        function openTransferModal(patientId, currentDocId, doctors) {
            const data = loadData();
            const patient = data.patients.find(p => p.id === patientId);
            
            if (!patient) {
                showMessage('Error: Patient record not found for transfer.', 'error');
                return;
            }
            
            const otherDoctors = doctors.filter(d => d.id !== currentDocId);

            const modalHtml = `
                <div id="transfer-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Transfer Patient: ${patient.name}</h3>
                        <form id="transfer-form" data-patient-id="${patientId}">
                            <label class="block text-gray-600 mb-2">Transfer To Doctor:</label>
                            <select id="transfer-doctor-id" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition mb-4">
                                <option value="" disabled selected>Select a Doctor</option>
                                ${otherDoctors.map(d => `<option value="${d.id}">Dr. ${d.name} (${d.intro})</option>`).join('')}
                            </select>
                            <div class="flex justify-end space-x-3">
                                <button type="button" id="close-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                <button type="submit" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Confirm Transfer</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('transfer-modal').remove());
            document.getElementById('transfer-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newDocId = document.getElementById('transfer-doctor-id').value;
                
                const data = loadData();
                const patient = data.patients.find(p => p.id === patientId);
                const appointment = data.appointments.find(app => app.patientId === patientId);
                const newDoctor = data.doctors.find(d => d.id === newDocId);
                
                if (patient && newDoctor) {
                    // 1. Update Patient's current Doctor ID
                    patient.currentDoctorId = newDocId;
                    
                    // 2. If an appointment exists, update its doctor ID.
                    if (appointment) {
                        appointment.doctorId = newDocId;
                    }
                    saveData(data);
                    showMessage(`Patient ${patient.name} successfully transferred to Dr. ${newDoctor.name}.`, 'success');
                }
                
                document.getElementById('transfer-modal').remove();
                renderStaffDashboard();
            });
        }

        function attachPatientListeners() {
            const data = loadData();
            const patient = currentState.user;
            
            // --- Step 1: City Selection Listener ---
            document.querySelectorAll('.select-city-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    patientBookingState.selectedCity = btn.getAttribute('data-city');
                    patientBookingState.selectedHospitalId = null;
                    patientBookingState.selectedDoctorId = null;
                    renderPatientDashboard();
                });
            });
            
            // --- Step 2: Hospital Selection Listener ---
            document.querySelectorAll('.select-hospital-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    patientBookingState.selectedHospitalId = btn.getAttribute('data-hospital');
                    patientBookingState.selectedDoctorId = null;
                    renderPatientDashboard();
                });
            });

            // --- Step 3: Doctor Selection Listener ---
            document.querySelectorAll('.select-doctor-btn').forEach(card => {
                card.addEventListener('click', () => {
                    patientBookingState.selectedDoctorId = card.getAttribute('data-id');
                    renderPatientDashboard(); 
                });
            });
            
            // --- Back Buttons ---
            document.getElementById('back-to-city')?.addEventListener('click', () => {
                patientBookingState.selectedCity = null;
                patientBookingState.selectedHospitalId = null;
                patientBookingState.selectedDoctorId = null;
                renderPatientDashboard();
            });
            
            document.getElementById('back-to-hospital')?.addEventListener('click', () => {
                patientBookingState.selectedHospitalId = null;
                patientBookingState.selectedDoctorId = null;
                renderPatientDashboard();
            });

            document.getElementById('back-to-doctor')?.addEventListener('click', () => {
                patientBookingState.selectedDoctorId = null;
                renderPatientDashboard();
            });


            // --- Step 4: Appointment Booking Submission ---
            const bookingForm = document.getElementById('appointment-booking-form');
            if (bookingForm) {
                bookingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const doctorId = document.getElementById('booking-doctor-id').value;
                    const hospitalId = document.getElementById('booking-hospital-id').value;
                    const date = document.getElementById('booking-date').value;
                    const time = document.getElementById('booking-time').value;
                    const name = document.getElementById('booking-name').value.trim();
                    const age = document.getElementById('booking-age').value.trim();
                    const weight = document.getElementById('booking-weight').value.trim();
                    
                    if (!doctorId) {
                         showMessage('Booking failed. Doctor ID is missing.', 'error');
                         return;
                    }

                    handleAppointmentBooking(currentState.user.id, doctorId, hospitalId, date, time, name, age, weight);
                });
            }

            // Vehicle Booking Logic
            const vehicleForm = document.getElementById('vehicle-booking-form');
            if (vehicleForm) {
                vehicleForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const from = document.getElementById('vehicle-from').value.trim();
                    const to = document.getElementById('vehicle-to').value.trim();
                    const type = document.getElementById('vehicle-type').value;

                    handleVehicleBooking(from, to, type);
                    vehicleForm.reset();
                });
            }
        }

        // Vehicle Booking Handler (Simplified)
        function handleVehicleBooking(from, to, type) {
            const data = loadData();
            const availableVehicle = data.vehicles.find(v => v.type === type && v.isAvailable);

            if (!availableVehicle) {
                 showMessage(`No ${type} vehicles currently available. Please try a different type.`, 'error');
                 return;
            }

            simulateUpiPayment((success) => {
                if (!success) return;

                availableVehicle.isAvailable = false; 
                saveData(data); // Save the temporary status change
                
                showMessage(`Vehicle (${availableVehicle.name}) booked from ${from} to ${to}. Driver dispatched!`, 'success');
                renderPatientDashboard();
                
                // Simulate trip completion after 10 seconds
                setTimeout(() => {
                    const updatedData = loadData();
                    const vehicle = updatedData.vehicles.find(v => v.id === availableVehicle.id);
                    if (vehicle) {
                        vehicle.isAvailable = true;
                        saveData(updatedData);
                        showMessage(`${vehicle.name} is now available again.`, 'warning');
                        if (currentState.role === 'patient') renderPatientDashboard();
                    }
                }, 10000); 
            });
        }


        // --- 9. INITIALIZATION AND MAIN ENTRY POINT ---

        /**
         * The main function to render the entire application based on the auth state.
         */
        function renderApplication() {
            // Data is always loaded synchronously from localStorage
            window.DATA = initializeData(); 

            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            if (currentState.isLoggedIn) {
                document.getElementById('login-view').classList.add('hidden');
                renderNavigation();
                // Ensure correct dashboard view is rendered on initial load
                if (currentState.subRole === 'doctor') renderDoctorDashboard();
                else if (currentState.subRole === 'staff') renderStaffDashboard();
                else if (currentState.role === 'hospital') renderHospitalDashboard();
                else if (currentState.role === 'patient') renderPatientDashboard();
                
            } else {
                renderLogin();
                document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('menu-button').classList.add('hidden');
            }
        }

        // Global Setup on Window Load
        window.onload = () => {
            lucide.createIcons(); 
            document.getElementById('menu-button').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
            });
            renderApplication(); // Start the application
        };

    </script>
</body>
</html>
